/*******************************************************************************
* (C) Copyright 2016;  WDBSystems, Bangalore
* The attached material and the information contained therein is proprietary
* to WDBSystems and is issued only under strict confidentiality arrangements.
* It shall not be used, reproduced, copied in whole or in part, adapted,
* modified, or disseminated without a written license of WDBSystems.           
* It must be returned to WDBSystems upon its first request.
*
*  File Name           : base64.c
*
*  Description         : It contains base64 conversion functions
*
*  Change history      : $Id$
*
*     Author        Date           Ver                 Description
*  ------------    --------        ---   --------------------------------------
*   venu kosuri   15th Mar 2016    1.1               Initial Creation
*  
*******************************************************************************/

/*******************************************************************************
*                          Include Files
*******************************************************************************/
#include "data_types.h"
#include "base64.h"

/*******************************************************************************
*                          Extern Data Declarations
*******************************************************************************/

/*******************************************************************************
*                          Extern Function Declarations
*******************************************************************************/

/*******************************************************************************
*                          Type & Macro Definitions
*******************************************************************************/

/*******************************************************************************
*                          Static Function Prototypes
*******************************************************************************/
static U8 find_index(U8 c);
/*******************************************************************************
*                          Static Data Definitions
*******************************************************************************/
static const char lut[]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

/*******************************************************************************
*                          Extern Data Definitions
*******************************************************************************/

/*******************************************************************************
*                          Extern Function Definitions
*******************************************************************************/

/*******************************************************************************
* Name       : 
* Description: 
* Remarks    : 
*******************************************************************************/
void BASE64_Enc(U8 *dst, U8 *src, U32 len)
{
    U32 l  = len / 3;
    U32 x;  
    U32 i;

    for (i = 0; i < l; i++) {
        x = src[0] << 16 | src[1] << 8 | src[2];
        src += 3;
#if 0
        *dst++ = lut[(x & 0b111111000000000000000000) >> 18];
        *dst++ = lut[(x & 0b000000111111000000000000) >> 12];
        *dst++ = lut[(x & 0b000000000000111111000000) >> 6];
        *dst++ = lut[ x & 0b000000000000000000111111];
#else

        *dst++ = lut[(x & 0xfc0000) >> 18];
        *dst++ = lut[(x & 0x03f000) >> 12];
        *dst++ = lut[(x & 0x000fc0) >> 6];
        *dst++ = lut[ x & 0x00003f];
#endif

    }    
    switch (len - l*3) {
        case 0:
            break;
        case 1:
            x = src[0] << 16 | 0 << 8 | 0;
#if 0
            *dst++ = lut[(x & 0b111111000000000000000000) >> 18];
            *dst++ = lut[(x & 0b000000111111000000000000) >> 12];
#else
            *dst++ = lut[(x & 0xfc0000) >> 18];
            *dst++ = lut[(x & 0x03f000) >> 12];
#endif
            *dst++ = '=';
            *dst = '=';
            break;
        case 2:
            x = src[0] << 16 | src[1] << 8 | 0;
#if 0
            *dst++ = lut[(x & 0b111111000000000000000000) >> 18];
            *dst++ = lut[(x & 0b000000111111000000000000) >> 12];
            *dst++ = lut[(x & 0b000000000000111111000000) >> 6];
#else
            *dst++ = lut[(x & 0xfc0000) >> 18];
            *dst++ = lut[(x & 0x03f000) >> 12];
            *dst++ = lut[(x & 0x000fc0) >> 6];
#endif
            *dst = '=';
            break;
    }
}

/*******************************************************************************
* Name       : 
* Description: 
* Remarks    : 
*******************************************************************************/
void BASE64_Dec(U8 *dst, U8 *src, U32 len)
{
    U32 l  = len / 4;
    U32 x;

    U32 i;

    for (i = 0; i < l; i++) 
    {
        x = find_index(src[0])<<26 | find_index(src[1]) << 20 | find_index(src[2]) <<14  | find_index(src[3])<<8;
        src += 4;
        *dst++ = x>>24;
        *dst++ = x>>16;
        *dst++ = x>>8;
   }

    /* As encoding takes care of padding , no  extra bytes expected */



}

/*******************************************************************************
*                          Static Function Definitions
*******************************************************************************/

/*******************************************************************************
* Name       : 
* Description: 
* Remarks    : 
*******************************************************************************/
U32 BASE64_EncLen(U32 s)
{
    U32 t = s * 4 / 3;

    if( t% 4 )
        return (t + (4 - t % 4));
        
    else
        return t;
}


/*******************************************************************************
* Name       : 
* Description: 
* Remarks    : 
*******************************************************************************/
static U8 find_index(U8 c)
{   

    U8 i; 
    for( i= 0; i<64; i++)
    {
        if(lut[i] == c)
            break;
    }

 //   printf("INDEX =%d\n", i);
    return i;
}

/*******************************************************************************
*                          End of File
*******************************************************************************/









